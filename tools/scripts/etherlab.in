#!/bin/sh

#------------------------------------------------------------------------------
#
#  Init script for EtherLab
#
#  $Id$
#
#  Copyright (C) 2006  Florian Pose, Ingenieurgemeinschaft IgH
#
#------------------------------------------------------------------------------

### BEGIN INIT INFO
# Provides:          etherlab
# Required-Start:    $local_fs $syslog $network
# Should-Start:      $time ntp ethercat
# Required-Stop:     $local_fs $syslog $network
# Should-Stop:       $time ntp ethercat
# Default-Start:     3 5
# Default-Stop:      0 1 2 6
# Short-Description: EtherLab AppCore
# Description:
### END INIT INFO

#------------------------------------------------------------------------------

SERVICE="EtherLab AppCore"
MODULE="rt_appcore"
MODULE_PATH="@prefix@/modules/$MODULE.ko"

#------------------------------------------------------------------------------

if test -r /etc/rc.status; then
. /etc/rc.status
else
function rc_reset () { :; }
function rc_status () { echo; }
function rc_exit  () { echo; exit; }
fi

#------------------------------------------------------------------------------

rc_reset

case "$1" in

	start)
		echo -n Starting $SERVICE

        if ! ( grep -q rtai_hal /proc/modules || insmod @RTAI_DIR@/modules/rtai_hal.ko ) || \
                ! ( egrep -q 'rtai_(up|sched)' /proc/modules || insmod @RTAI_DIR@/modules/rtai_up.ko ) || \
                ! ( grep -q rtai_sem /proc/modules || insmod @RTAI_DIR@/modules/rtai_sem.ko ) || \
                ! ( grep -q rtai_math /proc/modules || insmod @RTAI_DIR@/modules/rtai_math.ko ) || \
                ! insmod $MODULE_PATH; then
            /bin/false
            rc_status -v
            rc_exit
		fi

		rc_status -v
		;;

    stop)
		echo -n Shutting down $SERVICE

		if lsmod | grep "^$MODULE " > /dev/null; then
			if ! rmmod $MODULE; then
				/bin/false
				rc_status -v
				rc_exit
			fi;
		fi;

		rc_status -v
		;;

    restart)
		$0 stop || exit 1
		sleep 1
		$0 start
		rc_status
		;;

    status)
		echo -n Checking for $SERVICE

		lsmod | grep "^$MODULE " > /dev/null
		appcore_running=$?

		test $appcore_running -eq 0

		rc_status -v
		;;

    *)
		echo "USAGE: $0 {start|stop|restart|status}"
		;;

esac

rc_exit

#------------------------------------------------------------------------------
