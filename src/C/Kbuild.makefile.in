######################################################################
# $Id$
#
# This is the kernel makefile for hand coded C. 
#
# You should not need to change anything here. Your changes should
# be made in Makefile.mdl
#
# Copyright (C) 2008 Richard Hacker
# License: GPLv3
#
######################################################################


# Enter the name of you model here. This will be the file name of the
# kernel object that is created. This is also the name of the 
# Model Description File .xml file.
# Requirement: Mandatory
MODEL_NAME = my-model

# List the model sources here. Only .c files are supported. No absolute
# paths are allowed; the files have to be in the current directory or lower
# Requirement: Mandatory
MODEL_SOURCES = 

# CFLAGS with which your model will be built. Here you can conveniently
# add include paths for your model
# Requirement: Optional
#MODEL_CFLAGS = -I/custom/include



######## END OF USER CONFIGURABLE PART ##############################



ifeq ($(KERNELRELEASE),)

all %:
	$(MAKE) -C @LINUX_DIR@ M=$(shell pwd) $@

.linted: $(MODEL_NAME).xml
	xmllint @prefix@/lib/C/rt_model.xsd $^ > $@

else #ifeq ($(KERNELRELEASE),)

EXTRA_CFLAGS = \
        -I@ETHERLAB_DIR@ \
        -I@prefix@ \
        -I@RTAI_DIR@ \
        $(MODEL_CFLAGS) \
        -DMODEL=$(MODEL_NAME)

obj-m := $(MODEL_NAME).o
$(MODEL_NAME)-y := mdl_main.o data.o $(MODEL_SOURCES:.c=.o) \
        .src/register.o .src/rt_mdl_main.o
# Additionally mark the source files in .src as SECONDARY, so they are 
# not deleted, since they are needed by modpost.
.SECONDARY: $(obj)/.src/register.c

clean-dirs := .src
clean-files := .*.dep param.h cvt.h data.c model_defines.h .linted

# Kbuild can only compile files that are local to $(obj).
# If a file exists in the source distribution, copy it locally.
$(obj)/.src/%: @prefix@/src/kernel/%
	$(Q)mkdir -p .src
	$(Q)cp $< $@

$(obj)/data.o: headers

$(obj)/mdl_main.o: headers

headers: $(obj)/param.h $(obj)/cvt.h $(obj)/model_defines.h

quiet_cmd_xsltproc := XSLTPROC $@

-include $(obj)/.param.h.dep
$(obj)/param.h: $(obj)/$(MODEL_NAME).xml
	$(Q)@XSLTPROC@ @prefix@/lib/C/param_h.xsl $< | \
                @INDENT@ > $@
	$(Q)echo "$@: @prefix@/lib/C/param_h.xsl" > \
                $(obj)/.$(notdir $@).dep

-include $(obj)/.cvt.h.dep
$(obj)/cvt.h: $(obj)/$(MODEL_NAME).xml
	$(Q)@XSLTPROC@ @prefix@/lib/C/cvt_h.xsl $< | \
                @INDENT@ > $@
	$(Q)echo "$@: @prefix@/lib/C/cvt_h.xsl" > \
                $(obj)/.$(notdir $@).dep

-include $(obj)/.data.c.dep
$(obj)/data.c: $(obj)/$(MODEL_NAME).xml
	$(Q)@XSLTPROC@ @prefix@/lib/C/data_c.xsl $< | \
                @INDENT@ > $@
	$(Q)echo "$@: @prefix@/lib/C/data_c.xsl" > \
                $(obj)/.$(notdir $@).dep

-include $(obj)/.model_defines.h.dep
$(obj)/model_defines.h: $(obj)/$(MODEL_NAME).xml
	$(Q)@XSLTPROC@ @prefix@/lib/C/model_defines_h.xsl $< | \
                @INDENT@ > $@
	$(Q)echo "$@: @prefix@/lib/C/model_defines_h.xsl" > \
                $(obj)/.$(notdir $@).dep

XSL_FILE = @prefix@/lib/C/$(notdir $@).xsl
-include $(obj)/.model_defines.h.dep
$(obj)/mdf.c: $(obj)/$(MODEL_NAME).xml
	$(Q)@XSLTPROC@ $(XSL_FILE) $< | @INDENT@ > $@
	$(Q)echo "$@: $(XSL_FILE)" > $(obj)/.$(notdir $@).dep

endif #ifeq ($(KERNELRELEASE),)
